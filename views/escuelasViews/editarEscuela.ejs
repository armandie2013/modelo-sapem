<% const soloLectura = escuela.estado === 'Cerrado' && usuario?.rol !== 'admin'; %>

<div class="min-h-[calc(100vh-240px)] px-2 sm:px-4 py-2 sm:py-4 safe-bottom">
  <div class="mx-auto max-w-6xl">

    <div class="bg-white border border-gray-200 rounded-2xl shadow-xl overflow-hidden">
      <!-- Header -->
      <div class="px-4 sm:px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 via-white to-white">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">

          <div class="min-w-0">
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-gray-900">
              Editar Datos del Caso
            </h1>
            <p class="mt-0.5 text-xs sm:text-sm text-gray-600">
              Ticket:
              <span class="font-semibold text-gray-900"><%= escuela.numeroTicket %></span>
              · Estado:
              <span class="font-semibold text-gray-900"><%= escuela.estado %></span>
            </p>
          </div>

          <!-- Botón volver (oculto en mobile) -->
          <div class="hidden sm:block">
            <a
              href="/escuelas/dashboard"
              class="inline-flex items-center justify-center rounded-xl bg-gray-100 border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700
                     hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-blue-500/30"
            >
              Volver
            </a>
          </div>

        </div>
      </div>

      <div class="px-4 sm:px-6 py-4">

        <% if (soloLectura) { %>
          <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-4 text-center text-sm">
            Este caso se encuentra cerrado. Si es necesario, cree uno nuevo.
          </div>
        <% } %>

        <% if (typeof errores !== 'undefined' && errores.length > 0) { %>
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl mb-4 shadow-sm">
            <h2 class="font-semibold mb-1 text-sm">Por favor corregí los siguientes errores:</h2>
            <ul class="list-disc pl-5 text-xs sm:text-sm space-y-0.5">
              <% errores.forEach(error => { %>
                <li><%= error.msg %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <form
          action="/escuelas/<%= escuela._id %>/editar"
          method="POST"
          enctype="multipart/form-data"
          class="space-y-4"
        >
          <input type="hidden" name="editadoPor" value="<%= usuario?.nombre + ' ' + usuario?.apellido %>">

          <% const inputMain = "w-full rounded-xl border bg-white px-3 py-1.5 text-sm text-gray-900 transition " +
                               "border-blue-300 hover:border-blue-500 " +
                               "focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600"; %>

          <% const inputReadonly = "w-full rounded-xl border border-gray-300 bg-gray-50 px-3 py-1.5 text-sm text-gray-700"; %>

          <% const textareaMain = "w-full rounded-xl border bg-white px-3 py-3 text-sm text-gray-900 transition " +
                                  "border-blue-300 hover:border-blue-500 " +
                                  "focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600 resize-y"; %>

          <!-- ===== SECCIÓN 1: Identificación del caso ===== -->
          <section class="rounded-2xl border border-gray-200 bg-gray-50/60 p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h2 class="text-sm font-extrabold text-gray-900">Identificación del caso</h2>
                <p class="text-xs text-gray-600">Datos base y estado del reclamo.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
              <!-- Ticket -->
              <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Número de ticket</label>
                <input
                  type="text"
                  name="numeroTicket"
                  value="<%= escuela.numeroTicket %>"
                  class="<%= inputReadonly %>"
                  readonly
                >
              </div>

              <!-- Fecha -->
              <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Fecha</label>
                <input
                  type="date"
                  name="fechaDeCreacion"
                  value="<%= typeof datos !== 'undefined' ? datos.fechaDeCreacion : escuela.fechaDeCreacion.toISOString().split('T')[0] %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>

              <!-- Predio (max 6) -->
              <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Predio</label>
                <input
                  type="text"
                  name="predio"
                  value="<%= typeof datos !== 'undefined' ? datos.predio : escuela.predio %>"
                  required
                  inputmode="numeric"
                  maxlength="6"
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
                <p class="mt-1 text-[11px] text-gray-500">Máximo 6 dígitos.</p>
              </div>

              <!-- CUE (max 9) -->
              <div class="md:col-span-3">
                <label class="block text-xs font-medium text-gray-700 mb-1">CUE</label>
                <input
                  type="text"
                  name="cue"
                  value="<%= typeof datos !== 'undefined' ? datos.cue : escuela.cue %>"
                  required
                  inputmode="numeric"
                  maxlength="9"
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
                <p class="mt-1 text-[11px] text-gray-500">Máximo 9 dígitos.</p>
              </div>

              <!-- Estado -->
              <div class="md:col-span-3">
                <label for="estado" class="block text-xs font-medium text-gray-700 mb-1">Estado</label>

                <% if (usuario?.rol === 'admin' || escuela.estado === 'Abierto') { %>
                  <select
                    id="estado"
                    name="estado"
                    class="<%= inputMain %>"
                    <%= soloLectura ? "disabled" : "" %>
                  >
                    <option value="Abierto" <%= (typeof datos !== 'undefined' ? datos.estado : escuela.estado) === "Abierto" ? "selected" : "" %>>Abierto</option>
                    <option value="Cerrado" <%= (typeof datos !== 'undefined' ? datos.estado : escuela.estado) === "Cerrado" ? "selected" : "" %>>Cerrado</option>
                  </select>
                <% } else { %>
                  <input
                    type="text"
                    value="<%= escuela.estado %>"
                    disabled
                    class="<%= inputReadonly %>"
                  >
                  <input type="hidden" name="estado" value="<%= escuela.estado %>">
                <% } %>
              </div>
            </div>
          </section>

          <!-- ===== SECCIÓN 2: Ubicación ===== -->
          <section class="rounded-2xl border border-gray-200 bg-white p-4">
            <div class="mb-3">
              <h2 class="text-sm font-extrabold text-gray-900">Ubicación</h2>
              <p class="text-xs text-gray-600">Provincia, departamento y ciudad.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Provincia</label>
                <input
                  type="text"
                  name="provincia"
                  value="<%= typeof datos !== 'undefined' ? datos.provincia : escuela.provincia %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>

              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                <input
                  type="text"
                  name="departamento"
                  value="<%= typeof datos !== 'undefined' ? datos.departamento : escuela.departamento %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>

              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Ciudad</label>
                <input
                  type="text"
                  name="ciudad"
                  value="<%= typeof datos !== 'undefined' ? datos.ciudad : escuela.ciudad %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>
            </div>
          </section>

          <!-- ===== SECCIÓN 3: Datos de la escuela ===== -->
          <section class="rounded-2xl border border-gray-200 bg-white p-4">
            <div class="mb-3">
              <h2 class="text-sm font-extrabold text-gray-900">Datos de la escuela</h2>
              <p class="text-xs text-gray-600">Nombre, dirección y proveedor.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Nombre de la escuela</label>
                <input
                  type="text"
                  name="nombre"
                  value="<%= typeof datos !== 'undefined' ? datos.nombre : escuela.nombre %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>

              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Dirección</label>
                <input
                  type="text"
                  name="direccion"
                  value="<%= typeof datos !== 'undefined' ? datos.direccion : escuela.direccion %>"
                  required
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>

              <div class="md:col-span-4">
                <label class="block text-xs font-medium text-gray-700 mb-1">Proveedor</label>
                <input
                  type="text"
                  name="proveedor"
                  value="<%= typeof datos !== 'undefined' ? datos.proveedor : escuela.proveedor %>"
                  class="<%= inputMain %>"
                  <%= soloLectura ? "readonly" : "" %>
                >
              </div>
            </div>
          </section>

          <!-- ===== SECCIÓN 4: Detalles técnicos ===== -->
          <section class="rounded-2xl border border-gray-200 bg-white p-4">
            <div class="mb-3">
              <h2 class="text-sm font-extrabold text-gray-900">Detalles técnicos</h2>
              <p class="text-xs text-gray-600">Detalle del caso y observaciones del área técnica.</p>
            </div>

            <div class="mb-3">
              <label class="block text-xs font-medium text-gray-700 mb-1">Detalle del caso</label>
              <textarea
                name="detalleDelCaso"
                rows="6"
                class="<%= textareaMain %>"
                <%= soloLectura ? "readonly" : "" %>
              ><%= typeof datos !== 'undefined' ? datos.detalleDelCaso : escuela.detalleDelCaso %></textarea>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Observaciones técnicas</label>
              <textarea
                name="observacionesTecnica"
                rows="5"
                class="<%= textareaMain %>"
                <%= soloLectura ? "readonly" : "" %>
              ><%= typeof datos !== 'undefined' ? datos.observacionesTecnica : escuela.observacionesTecnica || '' %></textarea>
            </div>
          </section>

          <!-- ===== SECCIÓN 5: Imágenes ===== -->
          <section class="rounded-2xl border border-gray-200 bg-white p-4">
            <div class="mb-3">
              <h2 class="text-sm font-extrabold text-gray-900">Imágenes</h2>
              <p class="text-xs text-gray-600">Máximo 3 en total (incluye las ya guardadas).</p>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Cargar nuevas imágenes</label>
              <input
                type="file"
                name="imagenes"
                id="imagenes"
                accept="image/*"
                multiple
                class="w-full rounded-xl border bg-white px-3 py-2 text-sm text-gray-900 transition
                       border-blue-300 hover:border-blue-500
                       focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600"
                <%= soloLectura ? "disabled" : "" %>
                data-ya-cargadas="<%= escuela.imagenes?.length || 0 %>"
              >
              <div id="preview" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-3"></div>
            </div>

            <% if (escuela.imagenes && escuela.imagenes.length > 0) { %>
              <div class="mt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Imágenes cargadas:</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3" id="imagenes-guardadas">
                  <% escuela.imagenes.forEach((img) => { %>
                    <div class="relative imagen-guardada" data-nombre="<%= img %>">
                      <img
                        src="/archivos/escuelas/<%= escuela.numeroTicket %>/<%= img %>"
                        alt="Imagen cargada"
                        class="w-full h-auto rounded-xl border border-gray-200"
                      />
                      <% if (!soloLectura) { %>
                        <button
                          type="button"
                          class="quitar-imagen absolute top-2 right-2 rounded-full bg-red-50 border border-red-200 px-2 py-1 text-xs font-semibold text-red-700
                                 hover:bg-red-100 transition shadow-sm"
                        >
                          Quitar
                        </button>
                      <% } %>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% } else { %>
              <p class="text-sm text-gray-500 mt-2 italic">No hay imágenes cargadas para este caso.</p>
            <% } %>

            <input type="hidden" name="imagenesAEliminar" id="imagenesAEliminar" value="">
          </section>

          <% if (!soloLectura) { %>
            <div class="flex justify-end pt-3 border-t border-gray-200">
              <button
                type="submit"
                class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-5 py-2 text-sm font-semibold text-white
                       hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500/30"
              >
                Guardar Cambios
              </button>
            </div>
          <% } %>

        </form>

      </div>
    </div>
  </div>
</div>

<script>
  // Solo números + límite de dígitos (predio=6, cue=9)
  const limites = { predio: 6, cue: 9 };

  Object.keys(limites).forEach((name) => {
    const input = document.querySelector(`input[name="${name}"]`);
    if (!input || input.readOnly || input.disabled) return;

    input.setAttribute("inputmode", "numeric");
    input.setAttribute("maxlength", String(limites[name]));

    input.addEventListener("input", () => {
      input.value = input.value.replace(/\D/g, "").slice(0, limites[name]);
    });
  });
</script>

<script>
  const inputImagenes = document.getElementById("imagenes");
  const preview = document.getElementById("preview");
  const formulario = document.querySelector("form");
  const btnGuardar = formulario.querySelector('button[type="submit"]');
  const imagenesAEliminar = document.getElementById("imagenesAEliminar");
  const contenedorGuardadas = document.getElementById("imagenes-guardadas");

  let cantidadYaCargadas = parseInt(inputImagenes?.dataset.yaCargadas || "0");
  let nuevasImagenes = [];

  function actualizarEstadoBoton() {
    if (btnGuardar) btnGuardar.disabled = false;
  }

  inputImagenes?.addEventListener("change", function (event) {
    const seleccionadas = Array.from(event.target.files);

    if (cantidadYaCargadas + seleccionadas.length > 3) {
      alert(`Solo se permiten 3 imágenes. Ya hay ${cantidadYaCargadas} guardadas.`);
      inputImagenes.value = "";
      return;
    }

    preview.innerHTML = "";
    nuevasImagenes = seleccionadas;

    nuevasImagenes.forEach((file) => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const contenedor = document.createElement("div");
          contenedor.className = "relative";

          const img = document.createElement("img");
          img.src = e.target.result;
          img.className = "w-full h-auto rounded-xl border border-gray-200";

          const botonQuitar = document.createElement("button");
          botonQuitar.type = "button";
          botonQuitar.className = "absolute top-2 right-2 rounded-full bg-red-50 border border-red-200 px-2 py-1 text-xs font-semibold text-red-700 hover:bg-red-100 transition shadow-sm";
          botonQuitar.innerText = "Quitar";
          botonQuitar.addEventListener("click", () => {
            preview.removeChild(contenedor);
            nuevasImagenes = nuevasImagenes.filter(i => i !== file);
            if (nuevasImagenes.length === 0) inputImagenes.value = "";
            actualizarEstadoBoton();
          });

          contenedor.appendChild(img);
          contenedor.appendChild(botonQuitar);
          preview.appendChild(contenedor);

          actualizarEstadoBoton();
        };
        reader.readAsDataURL(file);
      }
    });
  });

  contenedorGuardadas?.addEventListener("click", function (e) {
    if (e.target.classList.contains("quitar-imagen")) {
      const contenedor = e.target.closest(".imagen-guardada");
      const nombreImagen = contenedor.getAttribute("data-nombre");
      contenedor.remove();

      const actuales = imagenesAEliminar.value ? imagenesAEliminar.value.split(",") : [];
      if (!actuales.includes(nombreImagen)) {
        actuales.push(nombreImagen);
        imagenesAEliminar.value = actuales.join(",");
        cantidadYaCargadas--;
        if (inputImagenes) inputImagenes.disabled = false;
        actualizarEstadoBoton();
      }
    }
  });
</script>

<script>
  function capitalizarCadaPalabra(texto) {
    return texto.toLowerCase().replace(/\b\w/g, letra => letra.toUpperCase());
  }

  function capitalizarPrimeraLetra(texto) {
    const limpio = texto.trim();
    if (!limpio) return "";
    return limpio.charAt(0).toUpperCase() + limpio.slice(1).toLowerCase();
  }

  const camposTitulo = ["nombre", "provincia", "departamento", "ciudad", "direccion", "proveedor"];
  camposTitulo.forEach(name => {
    const input = document.querySelector(`input[name="${name}"]`);
    if (input) {
      input.addEventListener("blur", () => {
        input.value = capitalizarCadaPalabra(input.value);
      });
    }
  });

  const camposParrafo = ["detalleDelCaso", "observacionesTecnica"];
  camposParrafo.forEach(name => {
    const textarea = document.querySelector(`textarea[name="${name}"]`);
    if (textarea) {
      textarea.addEventListener("blur", () => {
        textarea.value = capitalizarPrimeraLetra(textarea.value);
      });
    }
  });
</script>
