<main class="bg-gray-100 py-6 px-2 sm:px-4 md:px-2 lg:px-0">
  <div class="w-full max-w-[95vw] mx-auto bg-white p-4 sm:p-6 md:p-6 rounded-2xl shadow-xl border border-gray-300">

    <!-- ===== Encabezado + CTA ===== -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
      <div class="min-w-0">
        <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-gray-900">
          Listado de Casos · Escuelas
        </h1>
        <p class="mt-1 text-xs sm:text-sm text-gray-600">
          Buscá, filtrá y gestioná los reclamos técnicos.
        </p>
      </div>

      <% if (usuario?.modulosPermitidos?.escuelas?.crear) { %>
        <a
          href="/escuelas/crear"
          class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white
                 hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500/30"
        >
          Cargar Reclamo
        </a>
      <% } %>
    </div>

    <% 
      const total = (escuelas || []).length;
      const abiertos = (escuelas || []).filter(e => e.estado === 'Abierto').length;
      const cerrados = total - abiertos;

      const badge = (estado) => {
        if (estado === 'Abierto') return 'bg-emerald-50 text-emerald-700 border-emerald-200';
        return 'bg-red-50 text-red-700 border-red-200';
      };
    %>

    <!-- ===== Métricas rápidas ===== -->
    <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
        <p class="text-xs text-gray-600">Total de casos</p>
        <p class="mt-1 text-2xl font-extrabold text-gray-900"><%= total %></p>
      </div>
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50/60 p-4">
        <p class="text-xs text-emerald-700">Abiertos</p>
        <p class="mt-1 text-2xl font-extrabold text-emerald-800"><%= abiertos %></p>
      </div>
      <div class="rounded-2xl border border-red-200 bg-red-50/60 p-4">
        <p class="text-xs text-red-700">Cerrados</p>
        <p class="mt-1 text-2xl font-extrabold text-red-800"><%= cerrados %></p>
      </div>
    </div>

    <!-- ===== Barra de herramientas (buscar / filtros) ===== -->
    <div class="mt-5 rounded-2xl border border-gray-200 bg-white p-4">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3">

        <!-- Buscar -->
        <div class="md:col-span-6">
          <label class="block text-xs font-medium text-gray-700 mb-1">Buscar</label>
          <input
            id="filtroTexto"
            type="text"
            placeholder="Ticket, fecha, predio, CUE, escuela, ciudad, provincia, creado por..."
            class="w-full rounded-xl border bg-white px-3 py-2 text-sm text-gray-900 transition
                   border-blue-300 hover:border-blue-500
                   focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600"
          />
          <p class="mt-1 text-[11px] text-gray-500">Tip: podés escribir “cerrado”, “abierto”, “catamarca”, etc.</p>
        </div>

        <!-- Estado -->
        <div class="md:col-span-3">
          <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
          <select
            id="filtroEstado"
            class="w-full rounded-xl border bg-white px-3 py-2 text-sm text-gray-900 transition
                   border-blue-300 hover:border-blue-500
                   focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600"
          >
            <option value="Todos">Todos</option>
            <option value="Abierto">Abierto</option>
            <option value="Cerrado">Cerrado</option>
          </select>
        </div>

        <!-- Orden -->
        <div class="md:col-span-3">
          <label class="block text-xs font-medium text-gray-700 mb-1">Orden</label>
          <select
            id="orden"
            class="w-full rounded-xl border bg-white px-3 py-2 text-sm text-gray-900 transition
                   border-blue-300 hover:border-blue-500
                   focus:outline-none focus:ring-2 focus:ring-blue-500/25 focus:border-blue-600"
          >
            <option value="fecha_desc">Más nuevos</option>
            <option value="fecha_asc">Más viejos</option>
            <option value="ticket_asc">Ticket ↑</option>
            <option value="ticket_desc">Ticket ↓</option>
          </select>
        </div>

      </div>

      <div class="mt-3 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
        <p class="text-xs text-gray-600">
          Mostrando: <span id="contadorResultados" class="font-semibold text-gray-900"><%= total %></span> casos
        </p>

        <button
          type="button"
          id="btnLimpiar"
          class="inline-flex items-center justify-center rounded-xl bg-gray-100 border border-gray-300 px-3 py-2 text-sm font-semibold text-gray-700
                 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-blue-500/30"
        >
          Limpiar filtros
        </button>
      </div>
    </div>

    <% if (!escuelas || escuelas.length === 0) { %>
      <p class="text-gray-600 text-center mt-6">No hay escuelas registradas.</p>

    <% } else { %>

      <!-- ===== MOBILE: Cards ===== -->
      <div class="mt-5 grid grid-cols-1 gap-3 sm:hidden" id="cardsMobile">
        <% escuelas.forEach(escuela => { %>
          <article
            class="caso-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"
            data-ticket="<%= escuela.numeroTicket %>"
            data-predio="<%= escuela.predio %>"
            data-cue="<%= escuela.cue %>"
            data-nombre="<%= escuela.nombre %>"
            data-provincia="<%= escuela.provincia %>"
            data-ciudad="<%= escuela.ciudad %>"
            data-creadopor="<%= escuela.creadoPor %>"
            data-estado="<%= escuela.estado %>"
            data-fecha="<%= new Date(escuela.fechaDeCreacion).getTime() %>"
          >
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <p class="text-xs text-gray-500">Ticket</p>
                <p class="text-lg font-extrabold text-blue-800 leading-tight"><%= escuela.numeroTicket %></p>
                <p class="mt-1 text-sm font-semibold text-gray-900 truncate"><%= escuela.nombre %></p>
                <p class="text-xs text-gray-600 truncate"><%= escuela.ciudad %> · <%= escuela.provincia %></p>
              </div>

              <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-semibold <%= badge(escuela.estado) %>">
                <%= escuela.estado %>
              </span>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-gray-700">
              <!-- ✅ Creación visible (entre ticket y predio en “lectura”) -->
              <div class="rounded-xl bg-gray-50 border border-gray-200 p-2 col-span-2">
                <p class="text-[11px] text-gray-500">Creación</p>
                <p class="font-semibold"><%= new Date(escuela.fechaDeCreacion).toLocaleDateString('es-AR') %></p>
              </div>

              <div class="rounded-xl bg-gray-50 border border-gray-200 p-2">
                <p class="text-[11px] text-gray-500">Predio</p>
                <p class="font-semibold"><%= escuela.predio %></p>
              </div>

              <div class="rounded-xl bg-gray-50 border border-gray-200 p-2">
                <p class="text-[11px] text-gray-500">CUE</p>
                <p class="font-semibold"><%= escuela.cue %></p>
              </div>

              <div class="rounded-xl bg-gray-50 border border-gray-200 p-2 col-span-2">
                <p class="text-[11px] text-gray-500">Creado por</p>
                <p class="font-semibold"><%= escuela.creadoPor %></p>
              </div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              <% if (usuario?.modulosPermitidos?.escuelas?.ver) { %>
                <a href="/escuelas/<%= escuela._id %>" class="inline-flex items-center rounded-lg border border-blue-200 bg-blue-50 px-3 py-1.5 text-xs font-semibold text-blue-700 hover:bg-blue-100 transition">
                  Ver
                </a>
                <a href="/escuelas/<%= escuela._id %>/pdf" target="_blank" class="inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-100 transition">
                  PDF
                </a>
              <% } %>

              <% if (usuario?.modulosPermitidos?.escuelas?.editar) { %>
                <a href="/escuelas/<%= escuela._id %>/editar" class="inline-flex items-center rounded-lg border border-amber-200 bg-amber-50 px-3 py-1.5 text-xs font-semibold text-amber-700 hover:bg-amber-100 transition">
                  Editar
                </a>
              <% } %>

              <% if (usuario?.modulosPermitidos?.escuelas?.eliminar) { %>
                <form
                  action="/escuelas/<%= escuela._id %>?_method=DELETE"
                  method="POST"
                  class="inline"
                  onsubmit="return confirm('¿Estás seguro que deseas eliminar esta escuela?');"
                >
                  <button type="submit" class="inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-700 hover:bg-red-100 transition">
                    Eliminar
                  </button>
                </form>
              <% } %>
            </div>
          </article>
        <% }) %>
      </div>

      <!-- ===== DESKTOP: Tabla ===== -->
      <div class="mt-5 hidden sm:block">
        <div class="overflow-x-auto rounded-2xl border border-gray-200">
          <table class="w-full table-auto text-xs sm:text-sm border-collapse min-w-[1100px]" id="tablaCasos">
            <thead class="bg-gray-50 text-gray-700 font-semibold">
              <tr>
                <th class="px-3 py-3 text-left">Ticket</th>
                <!-- ✅ Creación ahora va entre Ticket y Predio -->
                <th class="px-3 py-3 text-left">Creación</th>
                <th class="px-3 py-3 text-left">Predio</th>
                <th class="px-3 py-3 text-left">CUE</th>
                <th class="px-3 py-3 text-left">Escuela</th>
                <th class="px-3 py-3 text-left">Provincia</th>
                <th class="px-3 py-3 text-left">Ciudad</th>
                <th class="px-3 py-3 text-left">Creado por</th>
                <th class="px-3 py-3 text-center">Estado</th>
                <th class="px-3 py-3 text-left">Acciones</th>
              </tr>
            </thead>

            <tbody id="tablaBody">
              <% escuelas.forEach(escuela => { %>
                <tr
                  class="caso-row border-t hover:bg-blue-50/40 transition"
                  data-ticket="<%= escuela.numeroTicket %>"
                  data-predio="<%= escuela.predio %>"
                  data-cue="<%= escuela.cue %>"
                  data-nombre="<%= escuela.nombre %>"
                  data-provincia="<%= escuela.provincia %>"
                  data-ciudad="<%= escuela.ciudad %>"
                  data-creadopor="<%= escuela.creadoPor %>"
                  data-estado="<%= escuela.estado %>"
                  data-fecha="<%= new Date(escuela.fechaDeCreacion).getTime() %>"
                >
                  <td class="px-3 py-3 font-extrabold text-blue-800">
                    <span class="inline-flex items-center rounded-lg border border-blue-200 bg-blue-50 px-2 py-1">
                      #<%= escuela.numeroTicket %>
                    </span>
                  </td>

                  <!-- ✅ Creación (movida) -->
                  <td class="px-3 py-3">
                    <%= new Date(escuela.fechaDeCreacion).toLocaleDateString('es-AR') %>
                  </td>

                  <td class="px-3 py-3"><%= escuela.predio %></td>
                  <td class="px-3 py-3"><%= escuela.cue %></td>
                  <td class="px-3 py-3 font-semibold text-gray-900"><%= escuela.nombre %></td>
                  <td class="px-3 py-3"><%= escuela.provincia %></td>
                  <td class="px-3 py-3"><%= escuela.ciudad %></td>
                  <td class="px-3 py-3"><%= escuela.creadoPor %></td>

                  <td class="px-3 py-3 text-center">
                    <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-semibold <%= badge(escuela.estado) %>">
                      <%= escuela.estado %>
                    </span>
                  </td>

                  <td class="px-3 py-3 whitespace-nowrap">
                    <div class="flex flex-wrap gap-2">
                      <% if (usuario?.modulosPermitidos?.escuelas?.ver) { %>
                        <a href="/escuelas/<%= escuela._id %>"
                          class="inline-flex items-center rounded-lg border border-blue-200 bg-blue-50 px-2.5 py-1.5 text-xs font-semibold text-blue-700 hover:bg-blue-100 transition">
                          Ver
                        </a>
                        <a href="/escuelas/<%= escuela._id %>/pdf" target="_blank"
                          class="inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-2.5 py-1.5 text-xs font-semibold text-emerald-700 hover:bg-emerald-100 transition">
                          PDF
                        </a>
                      <% } %>

                      <% if (usuario?.modulosPermitidos?.escuelas?.editar) { %>
                        <a href="/escuelas/<%= escuela._id %>/editar"
                          class="inline-flex items-center rounded-lg border border-amber-200 bg-amber-50 px-2.5 py-1.5 text-xs font-semibold text-amber-700 hover:bg-amber-100 transition">
                          Editar
                        </a>
                      <% } %>

                      <% if (usuario?.modulosPermitidos?.escuelas?.eliminar) { %>
                        <form action="/escuelas/<%= escuela._id %>?_method=DELETE" method="POST" class="inline"
                          onsubmit="return confirm('¿Estás seguro que deseas eliminar esta escuela?');">
                          <button type="submit"
                            class="inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-2.5 py-1.5 text-xs font-semibold text-red-700 hover:bg-red-100 transition">
                            Eliminar
                          </button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>

          </table>
        </div>
      </div>

    <% } %>

  </div>
</main>

<script>
  const filtroTexto = document.getElementById("filtroTexto");
  const filtroEstado = document.getElementById("filtroEstado");
  const orden = document.getElementById("orden");
  const contadorResultados = document.getElementById("contadorResultados");
  const btnLimpiar = document.getElementById("btnLimpiar");

  const rows = Array.from(document.querySelectorAll(".caso-row"));
  const cards = Array.from(document.querySelectorAll(".caso-card"));

  function normalizar(s) {
    return (s || "").toString().toLowerCase().trim();
  }

  function cumpleFiltro(el) {
    const q = normalizar(filtroTexto?.value);
    const est = filtroEstado?.value || "Todos";

    const texto = [
      el.dataset.ticket,
      // ✅ incluye “fecha” en la búsqueda (timestamp)
      new Date(Number(el.dataset.fecha || 0)).toLocaleDateString('es-AR'),
      el.dataset.predio,
      el.dataset.cue,
      el.dataset.nombre,
      el.dataset.provincia,
      el.dataset.ciudad,
      el.dataset.creadopor,
      el.dataset.estado
    ].map(normalizar).join(" ");

    const okTexto = !q || texto.includes(q);
    const okEstado = est === "Todos" || normalizar(el.dataset.estado) === normalizar(est);

    return okTexto && okEstado;
  }

  function aplicarFiltros() {
    let count = 0;

    rows.forEach(r => {
      const ok = cumpleFiltro(r);
      r.style.display = ok ? "" : "none";
      if (ok) count++;
    });

    cards.forEach(c => {
      const ok = cumpleFiltro(c);
      c.style.display = ok ? "" : "none";
    });

    if (contadorResultados) contadorResultados.textContent = String(count);
  }

  function aplicarOrden() {
    const value = orden?.value || "fecha_desc";

    const ordenarPor = (a, b) => {
      const fa = Number(a.dataset.fecha || 0);
      const fb = Number(b.dataset.fecha || 0);
      const ta = String(a.dataset.ticket || "");
      const tb = String(b.dataset.ticket || "");

      if (value === "fecha_desc") return fb - fa;
      if (value === "fecha_asc") return fa - fb;
      if (value === "ticket_asc") return ta.localeCompare(tb, "es-AR", { numeric: true });
      if (value === "ticket_desc") return tb.localeCompare(ta, "es-AR", { numeric: true });
      return 0;
    };

    // Tabla
    const tbody = document.getElementById("tablaBody");
    if (tbody) {
      const visibles = rows.filter(r => r.style.display !== "none");
      visibles.sort(ordenarPor).forEach(r => tbody.appendChild(r));
    }

    // Cards mobile
    const cardsWrap = document.getElementById("cardsMobile");
    if (cardsWrap) {
      const visiblesCards = cards.filter(c => c.style.display !== "none");
      visiblesCards.sort(ordenarPor).forEach(c => cardsWrap.appendChild(c));
    }
  }

  function refrescar() {
    aplicarFiltros();
    aplicarOrden();
  }

  filtroTexto?.addEventListener("input", refrescar);
  filtroEstado?.addEventListener("change", refrescar);
  orden?.addEventListener("change", refrescar);

  btnLimpiar?.addEventListener("click", () => {
    if (filtroTexto) filtroTexto.value = "";
    if (filtroEstado) filtroEstado.value = "Todos";
    if (orden) orden.value = "fecha_desc";
    refrescar();
  });

  // Inicial
  refrescar();
</script>
