<main class="bg-gray-100 min-h-screen py-10 px-4">
  <form action="/planes/crear" method="POST" id="formCrearPlan"
        class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-200 relative overflow-hidden space-y-6">

    <!-- Franja superior sutil (match vista proveedores) -->
    <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-indigo-500/70 via-sky-500/70 to-emerald-500/70"></div>

    <header class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Crear Plan</h1>
        <p class="text-sm text-gray-600">Definí el nombre, el detalle y el importe (USD) del plan.</p>
      </div>
      <a href="/planes"
         class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm text-gray-700 hover:text-gray-900 ring-1 ring-gray-200 hover:ring-gray-300 bg-white">
        ← Volver
      </a>
    </header>

    <% if (errores && errores.length) { %>
      <div class="bg-red-50 border border-red-300 text-red-800 px-5 py-4 rounded-lg shadow-sm text-sm">
        <h2 class="font-semibold mb-2">Por favor corregí los siguientes errores:</h2>
        <ul class="list-disc pl-6 space-y-1">
          <% errores.forEach(function(e){ %><li><%= e.msg %></li><% }) %>
        </ul>
      </div>
    <% } %>

    <!-- Campos -->
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      <!-- Nombre del plan -->
      <div class="sm:col-span-2">
        <label for="nombrePlan" class="block font-medium text-gray-800">Nombre del plan</label>
        <input
          type="text"
          name="nombre"
          id="nombrePlan"
          required
          maxlength="27"
          value="<%= (datos && datos.nombre) || '' %>"
          class="w-full border border-gray-300 px-3 py-2 rounded-lg text-sm tracking-wide focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
          aria-describedby="nombreHelp nombreCount"
          style="text-transform: uppercase"
        >
        <div class="flex items-center justify-between mt-1">
          <p id="nombreHelp" class="text-xs text-gray-500">
            Debe tener entre
            <span class="font-medium">20 y 27 caracteres</span> (incluye espacios).
          </p>
          <p id="nombreCount" class="text-xs text-gray-500">0 / 27</p>
        </div>
        <p id="nombreError" class="hidden mt-1 text-xs text-red-600">El nombre debe tener entre 20 y 27 caracteres.</p>
      </div>

      <!-- Detalle -->
      <div class="sm:col-span-2">
        <label class="block font-medium text-gray-800">Detalle</label>
        <textarea name="detalle" rows="3"
                  class="w-full border border-gray-300 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30"><%= (datos && datos.detalle) || '' %></textarea>
      </div>

      <!-- Importe -->
      <div class="sm:col-span-2 md:col-span-1">
        <label class="block font-medium text-gray-800">Importe (USD)</label>
        <div class="relative">
          <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-gray-500">US$</span>
          <input
            type="text"
            id="importeMask"
            inputmode="numeric"
            autocomplete="off"
            class="w-full border border-gray-300 pl-10 pr-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
            placeholder="0,00"
            aria-describedby="importeHelp"
          >
        </div>
        <input type="hidden" name="importe" id="importeHidden"
               value="<%= (datos && datos.importe) || '' %>">
        <p id="importeHelp" class="text-xs text-gray-500 mt-1">
          Mostrado con separador local (<span class="font-mono">12.345,67</span>). Se envía con punto decimal.
        </p>
      </div>
    </section>

    <!-- Acciones -->
    <footer class="flex flex-col sm:flex-row sm:justify-end gap-2 pt-2">
      <button
        type="submit"
        id="btnSubmit"
        class="inline-flex items-center gap-1.5 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm ring-1 ring-indigo-500/10 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Guardar
      </button>
      <a href="/planes"
         class="inline-flex items-center gap-1.5 bg-gray-100 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-200 transition ring-1 ring-gray-200">
        Cancelar
      </a>
    </footer>
  </form>
</main>

<script>
/* ==============================
   Nombre (MAYÚSCULAS, 20–27 chars)
   ============================== */
(function () {
  var input   = document.getElementById('nombrePlan');
  var counter = document.getElementById('nombreCount');
  var errorEl = document.getElementById('nombreError');
  var form    = document.getElementById('formCrearPlan');
  var submit  = document.getElementById('btnSubmit');

  var MIN_LEN = 20;
  var MAX_LEN = 27;

  function normalize() {
    var v = (input.value || '')
      .toUpperCase()
      .replace(/\r?\n/g, ' ')
      .replace(/\s+/g, ' ')
      .trimStart();

    if (v.length > MAX_LEN) v = v.slice(0, MAX_LEN);
    input.value = v;

    counter.textContent = v.length + ' / ' + MAX_LEN;

    var ok = (v.length >= MIN_LEN && v.length <= MAX_LEN);
    if (ok) {
      errorEl.classList.add('hidden');
      input.classList.remove('border-red-400', 'focus:border-red-500', 'focus:ring-red-200');
    }
    submit.disabled = !ok;
  }

  normalize();
  input.addEventListener('input', normalize);
  input.addEventListener('blur', normalize);

  form.addEventListener('submit', function (e) {
    normalize();
    var len = (input.value || '').length;
    if (len < MIN_LEN || len > MAX_LEN) {
      e.preventDefault();
      errorEl.classList.remove('hidden');
      input.classList.add('border-red-400', 'focus:border-red-500', 'focus:ring-red-200');
      input.focus();
    }
  });
})();

/* ==========================
   Importe con máscara USD
   ========================== */
(function () {
  var input = document.getElementById('importeMask');
  var hidden = document.getElementById('importeHidden');

  var intDigits = "";         // parte entera
  var decDigits = ["0","0"];  // dos decimales
  var editingDecimals = false;
  var decPos = 0;

  (function initFromHidden() {
    var v = hidden.value;
    if (!v) { render(); return; }
    var n = Number(v);
    if (isFinite(n)) {
      var entero = Math.trunc(Math.abs(n)).toString();
      var dec = Math.round((Math.abs(n) % 1) * 100).toString().padStart(2, "0");
      intDigits = entero.replace(/^0+(?=\d)/, '');
      decDigits = [dec[0], dec[1]];
    }
    render();
  })();

  function fmtThousands(s) {
    s = s || "0";
    s = s.replace(/^0+(?=\d)/, "");
    if (s === "") s = "0";
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function updateHidden() {
    var num = Number(intDigits || "0") + (Number(decDigits.join("")) / 100);
    hidden.value = num.toFixed(2);
  }
  function render() {
    var visible = fmtThousands(intDigits) + "," + decDigits.join("");
    input.value = visible;

    requestAnimationFrame(function () {
      var commaIndex = visible.indexOf(",");
      var pos = editingDecimals ? (commaIndex + 1 + decPos) : commaIndex;
      if (pos < 0) pos = 0;
      if (pos > visible.length) pos = visible.length;
      input.setSelectionRange(pos, pos);
    });

    updateHidden();
  }

  function parseAnyNumberLike(str) {
    var s = (str || "").trim();
    if (!s) return null;
    var lastComma = s.lastIndexOf(',');
    var lastDot = s.lastIndexOf('.');
    var decSep = null;
    if (lastComma > -1 || lastDot > -1) decSep = (lastComma > lastDot) ? ',' : '.';
    if (decSep === ',') { s = s.replace(/\./g, ''); s = s.replace(',', '.'); }
    else if (decSep === '.') { s = s.replace(/,/g, ''); }
    else { s = s.replace(/[.,\s]/g, ''); }
    var n = Number(s);
    return isFinite(n) && n >= 0 ? n : null;
  }

  input.addEventListener('beforeinput', function (e) {
    var type = e.inputType;
    var data = e.data;

    if (type === 'insertText' && /[0-9]/.test(data || "")) {
      if (editingDecimals) {
        if (decPos < 2) { decDigits[decPos] = data; decPos++; }
        else { decPos = 0; decDigits[decPos] = data; decPos = 1; }
      } else {
        intDigits += data;
        intDigits = intDigits.replace(/^0+(?=\d)/, '');
      }
      e.preventDefault(); render(); return;
    }

    if (type === 'insertText' && (data === '.' || data === ',')) {
      editingDecimals = true; decPos = 0;
      e.preventDefault(); render(); return;
    }

    if (type === 'deleteContentBackward') {
      e.preventDefault();
      if (editingDecimals) {
        if (decPos > 0) { decPos--; decDigits[decPos] = "0"; }
        else { editingDecimals = false; }
      } else {
        if (intDigits.length > 0) intDigits = intDigits.slice(0, -1);
      }
      render(); return;
    }

    if (type === 'insertFromPaste') {
      e.preventDefault();
      navigator.clipboard.readText().then(function (text) {
        var n = parseAnyNumberLike(text);
        if (n === null) return;
        var entero = Math.trunc(n).toString();
        var dec = Math.round((n % 1) * 100).toString().padStart(2, "0");
        intDigits = entero.replace(/^0+(?=\d)/, '');
        decDigits = [dec[0], dec[1]];
        editingDecimals = false; decPos = 0;
        render();
      }).catch(function () {});
      return;
    }

    e.preventDefault();
  });

  input.addEventListener('click', function () {
    var visible = input.value;
    var commaIndex = visible.indexOf(",");
    var caret = input.selectionStart || 0;

    var isInitialZero = (fmtThousands(intDigits) === "0" && decDigits.join("") === "00");
    if (isInitialZero) { editingDecimals = false; decPos = 0; render(); return; }

    if (caret > commaIndex) {
      editingDecimals = true;
      var after = caret - (commaIndex + 1);
      decPos = Math.max(0, Math.min(2, after));
      if (decPos >= 2) decPos = 1;
    } else {
      editingDecimals = false;
      decPos = 0;
    }
    render();
  });

  input.addEventListener('focus', function () {
    if (!input.value) {
      editingDecimals = false;
      decPos = 0;
      render();
    } else {
      input.dispatchEvent(new Event('click'));
    }
  });

  input.addEventListener('keypress', function (e) {
    var ch = e.key;
    if (!/[0-9.,]/.test(ch)) e.preventDefault();
  });
})();
</script>
