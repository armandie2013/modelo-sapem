<nav class="nav-hover bg-blue-800 text-white py-4 px-6 z-50 relative">
  <!-- Hover para links de nivel superior (los que llevan .navlink) -->
  <style>
    .nav-hover a.navlink {
      padding: .25rem .5rem;
      border-radius: .5rem;
      transition: background-color .15s ease;
    }
    .nav-hover a.navlink:hover {
      background: rgba(255,255,255,0.12);
    }
  </style>

  <div class="container mx-auto flex justify-between items-center">
    <!-- Logo / Marca -->
    <a href="/" class="text-lg font-semibold navlink">Catamarca Telecomunicaciones SAPEM</a>

    <!-- Zona derecha (desktop): USD + menú -->
    <div class="hidden md:flex items-center gap-6">
      <!-- USD (ayer hábil) + histórico -->
      <div class="relative flex items-center gap-3 border border-white/20 p-2 rounded-md">
        <% if (usdAyer && usdAyer.tipoCotizacion) { %>
          <div class="text-xs text-white/90">
            <span class="opacity-80">
              Fecha
              <%= new Intl.DateTimeFormat('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' })
                    .format(new Date(String(usdAyer.fecha)+'T00:00:00')) %>
            </span>
            <span class="font-semibold ml-1">USD:</span>
            <span class="font-mono">
              <%= new Intl.NumberFormat('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})
                    .format(usdAyer.tipoCotizacion) %>
            </span>
          </div>
        <% } else { %>
          <div class="text-xs text-white/90">
            <span class="font-semibold">USD</span>
            <span class="opacity-80">(ayer)</span>: <span class="font-mono">n/d</span>
          </div>
        <% } %>

        <!-- Botón para abrir panel de histórico -->
        <button id="usdToggle" type="button"
                class="text-xs bg-white/10 hover:bg-white/20 rounded-md px-2 py-1 transition-colors">
          Histórico
        </button>

        <!-- Panel histórico -->
        <div id="usdPanel"
             class="hidden absolute right-0 top-full mt-2 w-72 bg-white text-gray-800 rounded-lg shadow-lg p-3 z-50">
          <div class="flex items-start justify-between">
            <p class="text-sm font-medium">Cotización histórica</p>
            <button id="usdClose" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <label class="block text-xs text-gray-600 mt-2 mb-1">Buscar por fecha</label>
          <input id="usdDate" type="date" class="w-full border rounded px-2 py-1 text-sm" />
          <button id="usdFetch"
                  class="mt-2 w-full text-xs bg-indigo-600 text-white rounded px-2 py-1 hover:bg-indigo-700 transition-colors">
            Consultar
          </button>
          <div id="usdResult" class="mt-2 text-center text-xs text-gray-700"></div>
        </div>
      </div>

      <!-- Menú principal (desktop) -->
      <div class="flex items-center space-x-8">
        <% if (usuario && usuario.rol) { %>
          <!-- Administración -->
          <div class="relative">
            <button onclick="toggleDropdown('adminDropdown')"
                    class="hover:underline hover:bg-white/10 rounded-md px-2 py-1 transition-colors focus:outline-none">
              Administración ▾
            </button>
            <ul id="adminDropdown" class="hidden absolute bg-white text-black rounded-lg shadow-lg mt-2 w-52 z-50">
              <li><a href="/proveedores" class="block px-4 py-2 hover:bg-gray-200">Listado de Proveedores</a></li>
              <li><a href="/proveedores/registrar" class="block px-4 py-2 hover:bg-gray-200">Registrar Proveedor</a></li>

              <li><hr class="my-1 border-gray-200"></li>
              <li><a href="/planes" class="block px-4 py-2 hover:bg-gray-200">Planes</a></li>
              <li><a href="/planes/crear" class="block px-4 py-2 hover:bg-gray-200">Crear Plan</a></li>

              <li><hr class="my-1 border-gray-200"></li>
              <li><a href="/pagos" class="block px-4 py-2 hover:bg-gray-200">Listado de Pagos</a></li>
              <li><a href="/pagos/registrar" class="block px-4 py-2 hover:bg-gray-200">Registrar Pago</a></li>
              <li><a href="/notas/credito/registrar" class="block px-4 py-2 hover:bg-gray-200">Nota de Crédito</a></li>
              <li><a href="/notas/debito/registrar" class="block px-4 py-2 hover:bg-gray-200">Nota de Débito</a></li>

              <li><hr class="my-1 border-gray-200"></li>
              <li><a href="/tareas/cargos" class="block px-4 py-2 hover:bg-gray-200">Cargos mensuales</a></li>
            </ul>
          </div>

          <!-- Gerencia -->
          <div class="relative">
            <button onclick="toggleDropdown('gerenciaDropdown')"
                    class="hover:underline hover:bg-white/10 rounded-md px-2 py-1 transition-colors focus:outline-none">
              Gerencia ▾
            </button>
            <ul id="gerenciaDropdown" class="hidden absolute bg-white text-black rounded-lg shadow-lg mt-2 w-52 z-50">
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-200">Indicadores</a></li>
            </ul>
          </div>

          <!-- Proyectos -->
          <div class="relative">
            <button onclick="toggleDropdown('proyectosDropdown')"
                    class="hover:underline hover:bg-white/10 rounded-md px-2 py-1 transition-colors focus:outline-none">
              Proyectos ▾
            </button>
            <ul id="proyectosDropdown" class="hidden absolute bg-white text-black rounded-lg shadow-lg mt-2 w-52 z-50">
              <li><a href="/escuelas/dashboard" class="block px-4 py-2 hover:bg-gray-200">Escuelas</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-200">Nuevo Proyecto</a></li>
            </ul>
          </div>

          <!-- Técnica -->
          <div class="relative">
            <button onclick="toggleDropdown('tecnicaDropdown')"
                    class="hover:underline hover:bg-white/10 rounded-md px-2 py-1 transition-colors focus:outline-none">
              Técnica ▾
            </button>
            <ul id="tecnicaDropdown" class="hidden absolute bg-white text-black rounded-lg shadow-lg mt-2 w-52 z-50">
              <li><a href="/viaticos/dashboard" class="block px-4 py-2 hover:bg-gray-200">Viáticos</a></li>
              <li><a href="/pedidos-materiales/dashboard" class="block px-4 py-2 hover:bg-gray-200">Pedido de Materiales</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-200">Control de Stock</a></li>
            </ul>
          </div>

          <% if (usuario.rol==='admin' ) { %>
            <!-- Accesos admin -->
            <div class="relative">
              <button onclick="toggleDropdown('adminAccessDropdown')"
                      class="hover:underline hover:bg-white/10 rounded-md px-2 py-1 transition-colors focus:outline-none">
                Acceso Admin ▾
              </button>
              <ul id="adminAccessDropdown" class="hidden absolute bg-white text-black rounded-lg shadow-lg mt-2 w-52 z-50">
                <li><a href="/personas/dashboard" class="block px-4 py-2 hover:bg-gray-200">Personal SAPEM</a></li>
                <li><a href="/usuarios/dashboard" class="block px-4 py-2 hover:bg-gray-200">Usuarios Registrados</a></li>
              </ul>
            </div>
          <% } %>

          <!-- Logout -->
          <form action="/logout" method="POST" class="ml-2">
            <button class="bg-red-600 px-3 py-1 rounded hover:bg-red-800 transition-colors">Cerrar sesión</button>
          </form>

        <% } else { %>
          <!-- Visitantes -->
          <ul class="flex items-center space-x-6">
            <% if (rutaActual==="/registro" ) { %>
              <li><a href="/login" class="hover:underline navlink">Iniciar sesión</a></li>
            <% } else if (rutaActual==="/login" ) { %>
              <li><a href="/registro" class="hover:underline navlink">Registrarse</a></li>
            <% } else { %>
              <li><a href="/login" class="hover:underline navlink">Iniciar sesión</a></li>
              <li><a href="/registro" class="hover:underline navlink">Registrarse</a></li>
            <% } %>
          </ul>
        <% } %>
      </div>

      <!-- Botón hamburguesa (móvil, a la derecha) -->
      <button id="menu-toggle" class="md:hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>

    <!-- Menú móvil -->
    <div id="menu"
      class="hidden md:hidden flex-col absolute top-full left-0 w-full bg-blue-800 z-40 px-4 py-4 space-y-4">
      <!-- USD en móvil -->
      <div class="text-sm">
        <% if (usdAyer && usdAyer.tipoCotizacion) { %>
          <div>
            <span class="font-semibold">USD</span>
            <span class="opacity-80">
              (ayer <%= new Intl.DateTimeFormat('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' })
                          .format(new Date(String(usdAyer.fecha)+'T00:00:00')) %>)
            </span>:
            <span class="font-mono">
              <%= new Intl.NumberFormat('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})
                    .format(usdAyer.tipoCotizacion) %>
            </span>
          </div>
        <% } else { %>
          <div>USD: n/d</div>
        <% } %>
        <div class="mt-2">
          <label class="block text-xs text-white/80 mb-1">Histórico</label>
          <div class="flex gap-2">
            <input id="usdDateM" type="date" class="flex-1 rounded px-2 py-1 text-xs text-black" />
            <button id="usdFetchM" class="bg-white/10 hover:bg-white/20 rounded px-2 py-1 text-xs transition-colors">Consultar</button>
          </div>
          <div id="usdResultM" class="mt-2 text-xs"></div>
        </div>
      </div>

      <!-- Links móviles (si sos visitante) -->
      <% if (!usuario || !usuario.rol) { %>
        <ul class="flex flex-col gap-2">
          <li><a href="/login" class="navlink">Iniciar sesión</a></li>
          <li><a href="/registro" class="navlink">Registrarse</a></li>
        </ul>
      <% } %>
    </div>
  </div>
</nav>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Menú hamburguesa
    const menuToggle = document.getElementById("menu-toggle");
    const menu = document.getElementById("menu");
    menuToggle?.addEventListener("click", () => menu.classList.toggle("hidden"));

    // Dropdowns
    window.toggleDropdown = function toggleDropdown(id) {
      document.querySelectorAll("ul[id$='Dropdown']").forEach(el => {
        if (el.id !== id) el.classList.add("hidden");
      });
      document.getElementById(id)?.classList.toggle("hidden");
    };

    // Cerrar dropdowns haciendo click fuera
    document.addEventListener("click", function (e) {
      const isDropdownBtn = e.target.closest("button[onclick^='toggleDropdown']");
      const openDropdown = document.querySelector("ul[id$='Dropdown']:not(.hidden)");
      if (openDropdown && !openDropdown.contains(e.target) && !isDropdownBtn) {
        openDropdown.classList.add("hidden");
      }
    });

    // ---- Helpers de formato ----
    function formatISOtoDMY(iso) {
      try {
        return new Intl.DateTimeFormat('es-AR', {
          day:'2-digit', month:'2-digit', year:'numeric'
        }).format(new Date(String(iso) + 'T00:00:00'));
      } catch { return iso; }
    }

    // --- USD Histórico (desktop y móvil)
    const usdToggle = document.getElementById("usdToggle");
    const usdPanel  = document.getElementById("usdPanel");
    const usdClose  = document.getElementById("usdClose");
    usdToggle?.addEventListener("click", () => usdPanel?.classList.toggle("hidden"));
    usdClose?.addEventListener("click", () => usdPanel?.classList.add("hidden"));
    document.addEventListener("click", (e) => {
      if (!usdPanel || usdPanel.classList.contains("hidden")) return;
      if (!usdPanel.contains(e.target) && !usdToggle.contains(e.target)) {
        usdPanel.classList.add("hidden");
      }
    });

    async function queryUsd(dateStr, outEl) {
      if (!outEl) return;
      if (!dateStr) { outEl.textContent = "Elegí una fecha"; return; }
      outEl.textContent = "Consultando...";
      try {
        const r = await fetch(`/api/cambio/usd?fecha=${encodeURIComponent(dateStr)}`);
        const j = await r.json();
        if (j.ok && j.data && typeof j.data.tipoCotizacion === "number") {
          const n = new Intl.NumberFormat('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})
            .format(j.data.tipoCotizacion);
          const f = formatISOtoDMY(j.data.fecha);
          outEl.textContent = `${f} USD: ${n}`;
        } else {
          outEl.textContent = j.error || "Sin datos para esa fecha";
        }
      } catch (err) {
        outEl.textContent = "Error consultando la API";
      }
    }

    // Desktop
    document.getElementById("usdFetch")?.addEventListener("click", () => {
      const d = (document.getElementById("usdDate") || {}).value;
      queryUsd(d, document.getElementById("usdResult"));
    });

    // Móvil
    document.getElementById("usdFetchM")?.addEventListener("click", () => {
      const d = (document.getElementById("usdDateM") || {}).value;
      queryUsd(d, document.getElementById("usdResultM"));
    });
  });
</script>
