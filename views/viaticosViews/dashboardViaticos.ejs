<!-- Dashboard de Viáticos -->
<div class="bg-gray-100 py-6 px-2 sm:px-4 md:px-2 lg:px-0">
  <div class="w-full max-w-[95vw] mx-auto bg-white p-4 sm:p-6 md:p-6 rounded-2xl shadow-xl border border-gray-300">
    <!-- Encabezado -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
      <% if (usuario?.modulosPermitidos?.viaticos?.crear) { %>
        <a
          href="/viaticos/crear"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition text-sm"
        >
          Crear Viático
        </a>
      <% } %>

      <h1 class="text-xl sm:text-2xl font-semibold text-gray-800 text-center flex-1 sm:text-center">
        Listado de Viáticos
      </h1>

      <% if (!mostrarTodos) { %>
        <a
          href="/viaticos/dashboard/todos"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition text-sm"
        >
          Ver todos los viáticos
        </a>
      <% } else { %>
        <a
          href="/viaticos/dashboard"
          class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition text-sm"
        >
          Ver últimos 10
        </a>
      <% } %>
    </div>

    <% if (viaticos.length === 0) { %>
      <p class="text-gray-600 text-center">No hay viáticos disponibles.</p>
    <% } else { %>

      <!-- Filtros -->
      <div class="mb-4 p-3 sm:p-4 bg-gray-50 rounded-xl border border-gray-200">
        <div class="flex items-center justify-between mb-2 gap-2">
          <h2 class="text-sm font-semibold text-gray-700">
            Filtros
          </h2>
          <button
            type="button"
            id="btnLimpiarFiltrosViaticos"
            class="text-xs px-3 py-1.5 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100"
          >
            Limpiar filtros
          </button>
        </div>

        <div class="grid gap-2 sm:gap-3 sm:grid-cols-2 lg:grid-cols-4">
          <!-- Filtro Viajante -->
          <div>
            <label class="block text-[11px] font-medium text-gray-600 mb-1">
              Viajante
            </label>
            <input
              id="filtroViajante"
              type="text"
              placeholder="Buscar por nombre"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <!-- Filtros Fecha DESDE / HASTA -->
          <div>
            <div class="flex gap-1">
              <div class="w-1/2">
                <label class="block text-[11px] font-medium text-gray-600 mb-1">
                  Desde
                </label>
                <input
                  id="filtroFechaDesde"
                  type="date"
                  class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs
                         focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div class="w-1/2">
                <label class="block text-[11px] font-medium text-gray-600 mb-1">
                  Hasta
                </label>
                <input
                  id="filtroFechaHasta"
                  type="date"
                  class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs
                         focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>
          </div>

          <!-- Filtro Destino -->
          <div>
            <label class="block text-[11px] font-medium text-gray-600 mb-1">
              Destino
            </label>
            <input
              id="filtroDestino"
              type="text"
              placeholder="Buscar por destino"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <!-- Filtro Creado por -->
          <div>
            <label class="block text-[11px] font-medium text-gray-600 mb-1">
              Creado por
            </label>
            <input
              id="filtroCreador"
              type="text"
              placeholder="Buscar por usuario"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>
      </div>

      <!-- Tabla con scroll horizontal en pantallas chicas -->
      <div class="overflow-x-auto rounded-xl border border-gray-200">
        <table class="w-full table-auto text-xs sm:text-sm border-collapse min-w-[1100px]">
          <thead class="bg-gray-200 text-gray-700 font-semibold">
            <tr>
              <th class="px-2 py-2 text-left w-16">N°</th>
              <th class="px-2 py-2 text-left w-24">Fecha</th>
              <th class="px-2 py-2 text-left w-[16rem]">Viajantes</th>
              <th class="px-2 py-2 text-right w-28">Importes</th>
              <th class="px-2 py-2 text-left w-32">Origen</th>
              <th class="px-2 py-2 text-left w-32">Destino</th>
              <th class="px-2 py-2 text-left w-48">Motivo</th>
              <th class="px-2 py-2 text-right w-32">Total Viático</th>
              <th class="px-2 py-2 text-right w-24">Adicional</th>
              <th class="px-2 py-2 text-left w-32">Creado por</th>
              <th class="px-2 py-2 text-center w-28">Acciones</th>
            </tr>
          </thead>

          <tbody id="tablaViaticos">
            <% viaticos.forEach(v => { 
                 let fechaCreISO = '';
                 let fechaCreStr = '';

                 if (v.fechaDeCreacion) {
                   if (typeof v.fechaDeCreacion === 'string') {
                     const s = String(v.fechaDeCreacion).slice(0, 10);
                     fechaCreISO = s;
                     const partes = s.split('-');
                     fechaCreStr = partes[2] + '/' + partes[1] + '/' + partes[0];
                   } else {
                     const d = new Date(v.fechaDeCreacion);
                     const iso = d.toISOString().slice(0, 10);
                     fechaCreISO = iso;
                     const partes = iso.split('-');
                     fechaCreStr = partes[2] + '/' + partes[1] + '/' + partes[0];
                   }
                 }
            %>

              <tr class="border-b hover:bg-gray-50 transition" data-row-viatico>

                <!-- N° -->
                <td class="px-2 py-2 font-bold text-blue-800">
                  <%= v.numeroDeViaje %>
                </td>

                <!-- Fecha -->
                <td
                  class="px-2 py-2 whitespace-nowrap"
                  data-col="fecha"
                  data-fecha="<%= fechaCreISO %>"
                >
                  <%= fechaCreStr %>
                </td>

                <!-- Viajantes (nombres) -->
                <td class="px-2 py-2 align-middle" data-col="viajantes">
                  <ul class="list-disc ml-4 space-y-0.5">
                    <% v.viajantes.forEach(vj => { %>
                      <li class="whitespace-nowrap"><%= vj.nombre %></li>
                    <% }) %>
                  </ul>
                </td>

                <!-- Importes individuales -->
                <td class="px-2 py-2 text-right align-middle" data-col="importes">
                  <ul class="list-none space-y-0.5">
                    <% v.viajantes.forEach(vj => { %>
                      <li class="whitespace-nowrap">
                        $ <%= Number(vj.importe || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 }) %>
                      </li>
                    <% }) %>
                  </ul>
                </td>

                <!-- Origen (truncado) -->
                <td
                  class="px-2 py-2 max-w-[140px] truncate whitespace-nowrap overflow-hidden"
                  title="<%= v.origen %>"
                >
                  <%= v.origen %>
                </td>

                <!-- Destino (truncado) -->
                <td
                  class="px-2 py-2 max-w-[140px] truncate whitespace-nowrap overflow-hidden"
                  data-col="destino"
                  title="<%= v.destino %>"
                >
                  <%= v.destino %>
                </td>

                <!-- Motivo (truncado) -->
                <td
                  class="px-2 py-2 max-w-[220px] truncate whitespace-nowrap overflow-hidden"
                  title="<%= v.motivoDelViaje %>"
                >
                  <%= v.motivoDelViaje %>
                </td>

                <!-- Total Viático -->
                <td class="px-2 py-2 whitespace-nowrap text-right">
                  $ <%= v.montoTotalViatico.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                </td>

                <!-- Adicional en efectivo -->
                <td class="px-2 py-2 whitespace-nowrap text-right">
                  $ <%= v.adicionalEnEfectivo.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                </td>

                <!-- Creado por -->
                <td class="px-2 py-2 whitespace-nowrap" data-col="creadoPor">
                  <%= v.creadoPor %>
                </td>

                <!-- Acciones con iconos compactos -->
                <td class="px-2 py-2 whitespace-nowrap text-center">
                  <div class="inline-flex items-center gap-1">

                    <% if (usuario?.modulosPermitidos?.viaticos?.ver) { %>
                      <!-- Ver -->
                      <a
                        href="/viaticos/<%= v._id %>"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-slate-300
                               bg-slate-100 hover:bg-slate-200 text-slate-700 transition"
                        title="Ver detalle"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-width="2" d="M7 7h10M7 11h6m-2 4h8M5 3h10l4 4v12a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z"/>
                        </svg>
                      </a>

                      <!-- PDF -->
                      <a
                        href="/viaticos/<%= v._id %>/pdf"
                        target="_blank"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-emerald-300
                               bg-emerald-50 hover:bg-emerald-100 text-emerald-700 transition"
                        title="PDF"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-width="2" d="M7 3h8l4 4v12a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z"/>
                          <path stroke-width="2" d="M12 11v6m0 0l-2-2m2 2l2-2"/>
                        </svg>
                      </a>
                    <% } %>

                    <% if (usuario?.modulosPermitidos?.viaticos?.editar) { %>
                      <!-- Editar -->
                      <a
                        href="/viaticos/<%= v._id %>/editar"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-amber-300
                               bg-amber-50 hover:bg-amber-100 text-amber-700 transition"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-width="2" d="M15.232 5.232l3.536 3.536M16.5 3.5l-9 9V17h4.5l9-9L16.5 3.5z"/>
                        </svg>
                      </a>
                    <% } %>

                    <% if (usuario?.modulosPermitidos?.viaticos?.eliminar) { %>
                      <!-- Eliminar -->
                      <form
                        action="/viaticos/<%= v._id %>?_method=DELETE"
                        method="POST"
                        class="inline"
                        onsubmit="return confirm('¿Eliminar este viático?')"
                      >
                        <button
                          type="submit"
                          class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-red-300
                                 bg-red-50 hover:bg-red-100 text-red-700 transition"
                          title="Eliminar"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-width="2" d="M6 7h12M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2m1 0v12a2 2 0 01-2 2H8a2 2 0 01-2-2V7h10z"/>
                          </svg>
                        </button>
                      </form>
                    <% } %>

                  </div>
                </td>

              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filtroViajante   = document.getElementById('filtroViajante');
    const filtroFechaDesde = document.getElementById('filtroFechaDesde');
    const filtroFechaHasta = document.getElementById('filtroFechaHasta');
    const filtroDestino    = document.getElementById('filtroDestino');
    const filtroCreador    = document.getElementById('filtroCreador');
    const btnLimpiar       = document.getElementById('btnLimpiarFiltrosViaticos');
    const filas            = document.querySelectorAll('#tablaViaticos tr[data-row-viatico]');

    function normalizar(txt) {
      return (txt || '')
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function aplicarFiltros() {
      const valViajante   = normalizar(filtroViajante?.value || '');
      const valDestino    = normalizar(filtroDestino?.value || '');
      const valCreador    = normalizar(filtroCreador?.value || '');
      const valDesde      = (filtroFechaDesde?.value || '').trim();
      const valHasta      = (filtroFechaHasta?.value || '').trim();

      filas.forEach(tr => {
        const celViajantes = tr.querySelector('[data-col="viajantes"]');
        const celFecha     = tr.querySelector('[data-col="fecha"]');
        const celDestino   = tr.querySelector('[data-col="destino"]');
        const celCreador   = tr.querySelector('[data-col="creadoPor"]');

        if (!celFecha) return;

        const txtViajantes = normalizar(celViajantes ? celViajantes.textContent : '');
        const dataFecha    = celFecha.dataset.fecha || '';
        const txtDestino   = normalizar(celDestino ? celDestino.textContent : '');
        const txtCreador   = normalizar(celCreador ? celCreador.textContent : '');

        let ok = true;

        if (valViajante && !txtViajantes.includes(valViajante)) ok = false;
        if (valDestino && !txtDestino.includes(valDestino)) ok = false;
        if (valCreador && !txtCreador.includes(valCreador)) ok = false;

        if (valDesde && dataFecha < valDesde) ok = false;
        if (valHasta && dataFecha > valHasta) ok = false;

        tr.style.display = ok ? '' : 'none';
      });
    }

    [filtroViajante, filtroDestino, filtroCreador].forEach(input => {
      if (!input) return;
      input.addEventListener('input', aplicarFiltros);
    });

    if (filtroFechaDesde) filtroFechaDesde.addEventListener('change', aplicarFiltros);
    if (filtroFechaHasta) filtroFechaHasta.addEventListener('change', aplicarFiltros);

    if (btnLimpiar) {
      btnLimpiar.addEventListener('click', () => {
        if (filtroViajante)   filtroViajante.value   = '';
        if (filtroFechaDesde) filtroFechaDesde.value = '';
        if (filtroFechaHasta) filtroFechaHasta.value = '';
        if (filtroDestino)    filtroDestino.value    = '';
        if (filtroCreador)    filtroCreador.value    = '';
        aplicarFiltros();
      });
    }
  });
</script>
