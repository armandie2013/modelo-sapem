<script>
  const modulosActivos = <%= JSON.stringify(Object.keys(persona.modulosPermitidos || {})) %>;
</script>

<div class="bg-gray-100 min-h-screen py-8 flex justify-center items-start">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm border border-gray-300">
    <h1 class="text-2xl text-center text-gray-800 mb-6">Editar Personal</h1>

    <form action="/personas/editar/<%= persona._id %>?_method=PUT" method="POST" class="space-y-4">
      <!-- Datos Básicos -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Número de Orden</label>
        <input type="number" name="numeroOrden" value="<%= persona.numeroOrden %>" required
          class="w-full border px-3 py-2 rounded-lg">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Legajo</label>
        <input type="text" name="legajo" value="<%= persona.legajo %>" required
          class="w-full border px-3 py-2 rounded-lg">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Nombre y Apellido</label>
        <input type="text" name="nombreApellido" value="<%= persona.nombreApellido %>" required
          class="w-full border px-3 py-2 rounded-lg">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">DNI</label>
        <input type="text" name="dni" value="<%= persona.dni %>" required class="w-full border px-3 py-2 rounded-lg">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Cargo</label>
        <input type="text" name="cargo" value="<%= persona.cargo %>" required
          class="w-full border px-3 py-2 rounded-lg">
      </div>

      <!-- Permisos -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Permisos por Módulo</label>

        <!-- Técnica -->
        <div class="mb-3">
          <label class="inline-flex items-center">
            <input type="checkbox" class="modulo-checkbox mr-2" data-modulo="tecnica">
            <span class="text-base font-semibold">Técnica</span>
          </label>
        </div>

        <div id="sub-tecnica" class="space-y-4 ml-auto hidden">
          <div class="border border-gray-300 p-3 rounded">
            <p class="font-semibold mb-1">Viáticos</p>
            <div class="flex gap-4 flex-wrap">
              <label><input type="checkbox" name="modulosPermitidos[viaticos][ver]" value="true"
                  <%=(persona.modulosPermitidos.viaticos?.ver ? 'checked' : '' ) %>> Ver</label>
              <label><input type="checkbox" name="modulosPermitidos[viaticos][crear]" value="true"
                  <%=(persona.modulosPermitidos.viaticos?.crear ? 'checked' : '' ) %>> Crear</label>
              <label><input type="checkbox" name="modulosPermitidos[viaticos][editar]" value="true"
                  <%=(persona.modulosPermitidos.viaticos?.editar ? 'checked' : '' ) %>> Editar</label>
              <label><input type="checkbox" name="modulosPermitidos[viaticos][eliminar]" value="true"
                  <%=(persona.modulosPermitidos.viaticos?.eliminar ? 'checked' : '' ) %>> Eliminar</label>
            </div>
          </div>

          <div class="border border-gray-300 p-3 rounded">
            <p class="font-semibold mb-1">Control de Stock</p>
            <div class="flex gap-4 flex-wrap">
              <label><input type="checkbox" name="modulosPermitidos[stock][ver]" value="true"
                  <%=(persona.modulosPermitidos.stock?.ver ? 'checked' : '' ) %>> Ver</label>
              <label><input type="checkbox" name="modulosPermitidos[stock][crear]" value="true"
                  <%=(persona.modulosPermitidos.stock?.crear ? 'checked' : '' ) %>> Crear</label>
              <label><input type="checkbox" name="modulosPermitidos[stock][editar]" value="true"
                  <%=(persona.modulosPermitidos.stock?.editar ? 'checked' : '' ) %>> Editar</label>
              <label><input type="checkbox" name="modulosPermitidos[stock][eliminar]" value="true"
                  <%=(persona.modulosPermitidos.stock?.eliminar ? 'checked' : '' ) %>> Eliminar</label>
            </div>
          </div>

          <div class="border border-gray-300 p-3 rounded">
            <p class="font-semibold mb-1">Reclamos Técnicos</p>
            <div class="flex gap-4 flex-wrap">
              <label><input type="checkbox" name="modulosPermitidos[reclamos][ver]" value="true"
                  <%=(persona.modulosPermitidos.reclamos?.ver ? 'checked' : '' ) %>> Ver</label>
              <label><input type="checkbox" name="modulosPermitidos[reclamos][crear]" value="true"
                  <%=(persona.modulosPermitidos.reclamos?.crear ? 'checked' : '' ) %>> Crear</label>
              <label><input type="checkbox" name="modulosPermitidos[reclamos][editar]" value="true"
                  <%=(persona.modulosPermitidos.reclamos?.editar ? 'checked' : '' ) %>> Editar</label>
              <label><input type="checkbox" name="modulosPermitidos[reclamos][eliminar]" value="true"
                  <%=(persona.modulosPermitidos.reclamos?.eliminar ? 'checked' : '' ) %>> Eliminar</label>
            </div>
          </div>
        </div>

        <!-- Proyectos -->
        <div class="mb-3 mt-3">
          <label class="inline-flex items-center">
            <input type="checkbox" class="modulo-checkbox mr-2" data-modulo="proyectos">
            <span class="text-base font-semibold">Proyectos</span>
          </label>
        </div>

        <div id="sub-proyectos" class="space-y-4 ml-auto hidden">
          <div class="border border-gray-300 p-3 rounded">
            <p class="font-semibold mb-1">Escuelas</p>
            <div class="flex gap-4 flex-wrap">
              <label><input type="checkbox" name="modulosPermitidos[escuelas][ver]" value="true"
                  <%=(persona.modulosPermitidos.escuelas?.ver ? 'checked' : '' ) %>> Ver</label>
              <label><input type="checkbox" name="modulosPermitidos[escuelas][crear]" value="true"
                  <%=(persona.modulosPermitidos.escuelas?.crear ? 'checked' : '' ) %>> Crear</label>
              <label><input type="checkbox" name="modulosPermitidos[escuelas][editar]" value="true"
                  <%=(persona.modulosPermitidos.escuelas?.editar ? 'checked' : '' ) %>> Editar</label>
              <label><input type="checkbox" name="modulosPermitidos[escuelas][eliminar]" value="true"
                  <%=(persona.modulosPermitidos.escuelas?.eliminar ? 'checked' : '' ) %>> Eliminar</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Botón -->
      <div class="pt-4">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition">
          Guardar Cambios
        </button>
      </div>

    </form>
  </div>
</div>

<!-- Script limpio sin EJS adentro -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modulos = document.querySelectorAll('.modulo-checkbox');

    modulos.forEach((checkbox) => {
      const modulo = checkbox.dataset.modulo;
      const submodulo = document.getElementById(`sub-${modulo}`);

      // Mostrar submódulo si ya hay algún permiso marcado
      const tienePermisos = submodulo.querySelectorAll('input[type="checkbox"]:checked').length > 0;
      if (tienePermisos) {
        checkbox.checked = true;
        submodulo.classList.remove('hidden');
      }

      // Mostrar/ocultar según interacción
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          submodulo.classList.remove('hidden');
        } else {
          const algunoMarcado = [...submodulo.querySelectorAll('input[type="checkbox"]')].some(i => i.checked);
          if (!algunoMarcado) {
            submodulo.classList.add('hidden');
          }
        }
      });
    });
  });
</script>