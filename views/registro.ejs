<!-- ===================== TOAST (ARRIBA Y CENTRADO, APILABLE) ===================== -->
<% if (errores && errores.length > 0) { %>
  <div id="toastLayer" class="fixed inset-x-0 top-4 z-50 pointer-events-none">
    <div class="mx-auto w-full max-w-sm px-4">
      <div id="toastStack" class="flex flex-col items-center gap-2">
        <% errores.forEach(function(e){ %>
          <div class="toastItem pointer-events-auto w-full rounded-xl text-white shadow-2xl ring-1 ring-red-400/40
                      bg-red-600/90 backdrop-blur-sm px-5 py-3 animate-toast-drop text-sm">
            <div class="flex items-start gap-2">
              <!-- Icono -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 3h.01M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              </svg>
              <!-- Mensaje -->
              <div class="flex-1"><%= e.mensaje %></div>
              <!-- Cerrar -->
              <button type="button" aria-label="Cerrar"
                      class="ml-1 opacity-90 hover:opacity-100 transition"
                      onclick="this.closest('.toastItem')?.remove(); if(!document.querySelector('#toastStack .toastItem')) document.getElementById('toastLayer')?.remove()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <!-- Progreso -->
            <div class="mt-2 h-1 w-full bg-white/20 rounded overflow-hidden">
              <div class="h-1 w-full bg-white/75 animate-toast-progress"></div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>
<% } %>
<!-- ===================== /TOAST ===================== -->


<!-- Header (mismo estilo que login) -->
<header class="relative">
  <div class="h-32 sm:h-40 md:h-44 bg-indigo-600 rounded-t-3xl"></div>
  <div class="pointer-events-none absolute inset-0 h-32 sm:h-40 md:h-44 rounded-t-3xl
              bg-[radial-gradient(24rem_12rem_at_80%_-20%,rgba(255,255,255,.25),transparent)]"></div>
</header>

<!-- Contenido -->
<main class="relative -mt-16 sm:-mt-20 md:-mt-24 px-3 sm:px-4 pb-8">
  <div class="mx-auto w-full max-w-md">
    <!-- Card -->
    <div class="bg-white w-full p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-200">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 text-center mb-1">Crear cuenta</h2>
      <p class="text-xs sm:text-sm text-gray-500 text-center mb-5 sm:mb-6">Ingresá tus datos para registrarte</p>

      <!-- FORMULARIO (compacto, una columna, inputs chicos) -->
      <form action="/registro" method="POST" id="formRegistro" class="grid grid-cols-1 gap-y-2">

        <!-- Nombre -->
        <div>
          <label for="nombre" class="block text-xs text-gray-700 mb-0.5">Nombre</label>
          <input type="text" id="nombre" name="nombre" required
                 class="h-9 w-full px-2.5 rounded-md border border-gray-300 text-sm leading-tight
                        focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 placeholder="Ej: Juan" value="<%= usuario?.nombre || '' %>">
        </div>

        <!-- Apellido -->
        <div>
          <label for="apellido" class="block text-xs text-gray-700 mb-0.5">Apellido</label>
          <input type="text" id="apellido" name="apellido" required
                 class="h-9 w-full px-2.5 rounded-md border border-gray-300 text-sm leading-tight
                        focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 placeholder="Ej: Pérez" value="<%= usuario?.apellido || '' %>">
        </div>

        <!-- DNI -->
        <div>
          <label for="dni" class="block text-xs text-gray-700 mb-0.5">DNI</label>
          <input type="text" id="dni" name="dni" required inputmode="numeric" autocomplete="off"
                 pattern="[0-9]{8}" maxlength="8" title="Ingrese exactamente 8 dígitos (0–9)"
                 aria-describedby="dniError"
                 class="h-9 w-full px-2.5 rounded-md border border-gray-300 text-sm leading-tight
                        focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 placeholder="Ej: 30123456" value="<%= usuario?.dni || '' %>">
          <p id="dniError" class="mt-0.5 text-[11px] text-red-600 hidden">El DNI debe tener exactamente 8 dígitos.</p>
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-xs text-gray-700 mb-0.5">Correo electrónico</label>
          <input type="email" id="email" name="email" required
                 class="h-9 w-full px-2.5 rounded-md border border-gray-300 text-sm leading-tight
                        focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 placeholder="correo@ejemplo.com" value="<%= usuario?.email || '' %>">
        </div>

        <!-- Contraseña -->
        <div>
          <label for="password" class="block text-xs text-gray-700 mb-0.5">Contraseña</label>
          <div class="relative">
            <input type="password" id="password" name="password" required autocomplete="new-password"
                   class="h-9 w-full px-2.5 pr-9 rounded-md border border-gray-300 text-sm leading-tight
                          focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                   placeholder="********">
            <button type="button" aria-label="Mostrar u ocultar contraseña"
                    class="absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
              <svg onclick="(()=>{const i=document.getElementById('password');i.type=i.type==='password'?'text':'password';})()"
                   xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12 18 18.75 12 18.75 2.25 12 2.25 12z"/>
                <circle cx="12" cy="12" r="3" stroke-width="1.5"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Repetir Contraseña -->
        <div>
          <label for="confirmarPassword" class="block text-xs text-gray-700 mb-0.5">Repetir Contraseña</label>
          <div class="relative">
            <input type="password" id="confirmarPassword" name="confirmarPassword" required autocomplete="new-password"
                   class="h-9 w-full px-2.5 pr-9 rounded-md border border-gray-300 text-sm leading-tight
                          focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                   placeholder="********">
            <button type="button" aria-label="Mostrar u ocultar contraseña"
                    class="absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
              <svg onclick="(()=>{const i=document.getElementById('confirmarPassword');i.type=i.type==='password'?'text':'password';})()"
                   xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12 18 18.75 12 18.75 2.25 12 2.25 12z"/>
                <circle cx="12" cy="12" r="3" stroke-width="1.5"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- CTA -->
        <div class="pt-0.5">
          <button type="submit"
                  class="w-full h-9 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-md shadow transition active:scale-[.99]">
            Registrarse
          </button>
        </div>
      </form>
    </div>

    <p class="mt-4 sm:mt-6 text-center text-[11px] sm:text-xs text-gray-500">
      Al registrarte aceptás nuestros términos y política de privacidad.
    </p>
  </div>
</main>

<!-- Capitalización + DNI + Toast -->
<script>
  // Capitalizar nombre y apellido
  function capitalizarPrimeraLetra(texto){return texto.charAt(0).toUpperCase()+texto.slice(1).toLowerCase();}
  function aplicarCapitalizacion(input){
    input.addEventListener("input",function(){
      const palabras=this.value.split(" ").map(capitalizarPrimeraLetra);
      this.value=palabras.join(" ");
    });
  }

  document.addEventListener("DOMContentLoaded",()=> {
    const campoNombre=document.getElementById("nombre");
    const campoApellido=document.getElementById("apellido");
    const form=document.getElementById("formRegistro");
    const dni=document.getElementById("dni");
    const dniError=document.getElementById("dniError");

    if(campoNombre) aplicarCapitalizacion(campoNombre);
    if(campoApellido) aplicarCapitalizacion(campoApellido);

    // Validación DNI
    const CONTROL_KEYS=new Set(["Backspace","Delete","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","Tab","Enter","Escape"]);
    function isDigitKey(e){ if(e.ctrlKey||e.metaKey||CONTROL_KEYS.has(e.key)) return true; return /^[0-9]$/.test(e.key); }
    function sanitizeDni(v){ return (v||"").replace(/\D/g,"").slice(0,8); }
    function validarDni(){
      dni.value=sanitizeDni(dni.value);
      const ok=/^[0-9]{8}$/.test(dni.value);
      dni.setCustomValidity(ok?"":"El DNI debe tener exactamente 8 dígitos (0–9).");
      if(dniError) dniError.classList.toggle("hidden",ok);
      dni.classList.toggle("border-red-500",!ok);
      return ok;
    }
    if(dni){
      dni.addEventListener("keydown",(e)=>{ if(!isDigitKey(e)) e.preventDefault(); });
      dni.addEventListener("input",validarDni);
      dni.addEventListener("paste",(e)=>{
        e.preventDefault();
        const text=(e.clipboardData||window.clipboardData).getData("text")||"";
        const limpio=sanitizeDni(text);
        const start=dni.selectionStart??dni.value.length;
        const end=dni.selectionEnd??dni.value.length;
        dni.value=(dni.value.slice(0,start)+limpio+dni.value.slice(end)).slice(0,8);
        validarDni();
      });
      dni.addEventListener("blur",validarDni);
      dni.addEventListener("invalid",()=>validarDni());
    }
    if(form){
      form.addEventListener("submit",(e)=>{ if(!validarDni()){ e.preventDefault(); dni.focus(); } });
    }

    // Autocerrar toasts (si existen)
    const stack=document.getElementById('toastStack');
    const layer=document.getElementById('toastLayer');
    if (stack && layer) {
      [...stack.querySelectorAll('.toastItem')].forEach((el, idx) => {
        setTimeout(() => {
          el.style.transition='opacity .25s ease, transform .25s ease';
          el.style.opacity='0';
          el.style.transform='translateY(-4px)';
          setTimeout(() => {
            el.remove();
            if (!stack.querySelector('.toastItem')) layer.remove();
          }, 260);
        }, 4000 + idx*120);
      });
    }
  });
</script>

<!-- Estilos -->
<style>
  /* Entrada sutil desde arriba */
  @keyframes toast-drop { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
  .animate-toast-drop { animation: toast-drop .25s ease-out both; }

  /* Progreso 4s */
  @keyframes toast-progress { from { transform: scaleX(1); } to { transform: scaleX(0); } }
  .animate-toast-progress { transform-origin: left center; animation: toast-progress 4s linear forwards; }
</style>
